<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/reset-min.css">
        <link rel="stylesheet" type="text/css" href="css/r-node-ui.css">
        <link rel="stylesheet" href="js/jquery/fancybox/jquery.fancybox-1.3.1.css" type="text/css" media="screen">
        <link rel="stylesheet" type="text/css" href="js/jquery/jcarousel/lib/jquery.jcarousel.css" />
        <link rel="stylesheet" type="text/css" href="js/jquery/jcarousel/skins/tango/skin.css" />

        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.min.js"></script>
        <script type="text/javascript" src="http://localhost/protovis-v3.2/protovis-d3.2.js"></script>
        <script type="text/javascript" src="js/jquery/fancybox/jquery.fancybox-1.3.1.js"></script>
        <script type="text/javascript" src="js/jquery/jcarousel/lib/jquery.jcarousel.pack.js"></script>
        <script type="text/javascript" src="js/shared/display-r.js"></script>
        <script type="text/javascript" src="js/shared/parser.js"></script>
        <script type="text/javascript" src="js/shared/graphs.js"></script>
        <title>R</title>
    </head>
    <body>
        <div id="outerHolder">
            <div style="height:10; width: 100%"></div>
            <div id="banner"></div>
            <div id="console"></div>
            <div id="entrydiv">
                <input id="entryfield" type="text" />
            </div>
            <div id="plot" style="display: none; height: 400; width: 800; overflow:none"></div>

            <script type="text/javascript">

                var savedPlots = [];
                var lastQuery;

                function doPlot (plotter, data) {
                    savedPlots.push ({data: data, plotter: plotter });
                    plotter.plot ("plot", data);
                    $('#plot').trigger('click');
                    addToCarousel();
                }

                var rParser = new rnode.R.Parser();
                var rDisplay = new rnode.R.Display().setPlotter(doPlot);

                function addToConsole(t, isResponse) {
                    if (isResponse) {
                        $('#console div').last().append ("<pre class='r-response'>" + t + "</pre>");
                    } else {
                        $('#console').append ("<div class='console-snippet'><pre class='r-request'>" + t + "</pre></div>");
                    }
                }

                function queryR(s) {
                    lastQuery = s;
                    var x = rParser.parse (s);
                    $.ajax({
                        url: "/R/" + encodeURIComponent(x),
                        success: function (data) {
                            var results = $.parseJSON(data);
                            addToConsole(rDisplay.display(results), true);
                            $("#console").attr({ scrollTop: $("#console").attr("scrollHeight") });
                        }
                    });
                }


                function addToCarousel () {
                    var i = savedPlots[savedPlots.length - 1];
                    $('#mainCarousel').append ("<div class='carousel-item' title='" + encodeURIComponent(lastQuery) + "' id='carouselitem" + savedPlots.length + "'></div>");
                    i.plotter.plot ("carouselitem" + savedPlots.length, i.data, 1);
                    $('#carouselitem' +  savedPlots.length).click(function () { 
                        i.plotter.plot ("plot", i.data);
                        $('#plot').trigger('click');
                    });
                }

                $(document).ready(function() {
                    $('#entryfield').focus();

                    $.ajax({
                        url: "/blurb",
                        success: function (data) {
                            addToConsole (data);
                        }
                    });

                    $('#entryfield').change(function () {
                        var q = $(this).val();
                        addToConsole("> " + q, false);
                        queryR(q);
                        $(this).val('');
                    });

                    $("#plot").fancybox({
                        'scrolling': 'no',
                        'titleShow': false,
                        'onClosed': function () {
                            $('#plot').html('').hide();
                        }
                    });



                });
            </script>
            <div class="push"></div>
        </div>

        <div id="carouselwrapper">
            <h1>Recent Graphs</h1>
            <div id="mainCarousel" class="carousel">&nbsp;</div>
        </div>
    </body>
</html>
